{% extends "base.html" %}

{% block title %}Rental Recon - Home{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get the origin address when page loads
        fetch('/api/settings/origin')
            .then(response => response.json())
            .then(data => {
                if (data.origin_address) {
                    document.getElementById('originAddress').value = data.origin_address;
                }
            })
            .catch(error => console.error('Error fetching origin address:', error));
            
        // Option key detection for admin controls
        let optionKeyPressed = false;
        const adminControls = document.getElementById('adminControls');
        
        // Key down event listener
        document.addEventListener('keydown', function(e) {
            // Check for Option key (Alt key on Windows, Option key on Mac)
            if (e.key === 'Alt' || e.key === 'AltGraph' || e.key === 'Meta') {
                optionKeyPressed = true;
                adminControls.style.display = 'block';
            }
        });
        
        // Key up event listener
        document.addEventListener('keyup', function(e) {
            if (e.key === 'Alt' || e.key === 'AltGraph' || e.key === 'Meta') {
                optionKeyPressed = false;
                adminControls.style.display = 'none';
            }
        });
        
        // When window loses focus, hide admin controls
        window.addEventListener('blur', function() {
            optionKeyPressed = false;
            adminControls.style.display = 'none';
        });
        
        // Reset database button click handler
        document.getElementById('resetDatabaseBtn').addEventListener('click', function() {
            if (confirm('WARNING: This will delete ALL data in the database. This action cannot be undone. Continue?')) {
                fetch('/api/admin/reset-database', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    alert('Database has been reset successfully!');
                    window.location.reload();
                })
                .catch(error => {
                    console.error('Error resetting database:', error);
                    alert('Failed to reset database. See console for details.');
                });
            }
        });
        
        // Handle settings form submission
        document.getElementById('settingsForm').addEventListener('submit', function(event) {
            event.preventDefault();
            
            // Form validation
            if (!this.checkValidity()) {
                event.stopPropagation();
                this.classList.add('was-validated');
                return;
            }
            
            const originAddress = document.getElementById('originAddress').value;
            const formData = new FormData();
            formData.append('origin_address', originAddress);
            
            fetch('/api/settings/', {
                method: 'PUT',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Show success alert
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
                alertDiv.setAttribute('role', 'alert');
                alertDiv.innerHTML = `
                    <strong>Success!</strong> Origin address updated successfully.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.getElementById('settingsForm').after(alertDiv);
                
                // Auto dismiss after 3 seconds
                setTimeout(() => {
                    const bsAlert = new bootstrap.Alert(alertDiv);
                    bsAlert.close();
                }, 3000);
            })
            .catch(error => {
                console.error('Error updating settings:', error);
                // Show error alert
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
                alertDiv.setAttribute('role', 'alert');
                alertDiv.innerHTML = `
                    <strong>Error!</strong> Failed to update origin address.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.getElementById('settingsForm').after(alertDiv);
            });
        });
    });
</script>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Hidden database reset button - only visible when Option key is held -->
    <div id="adminControls" style="display: none; position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
        <button id="resetDatabaseBtn" class="btn btn-danger">Reset Database</button>
    </div>
    <h1 class="display-4">Welcome to Rental Recon</h1>
    <p class="lead">Track and manage your rental property opportunities in one place.</p>
    <hr class="my-4">
    <p>Start by adding a new property or browse existing listings.</p>
    <p class="lead">
        <a class="btn btn-primary btn-lg" href="/properties/new" role="button">Add New Property</a>
        <a class="btn btn-secondary btn-lg" href="/properties" role="button">View Properties</a>
    </p>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Origin Address for Travel Times</h5>
    </div>
    <div class="card-body">
        <form id="settingsForm" class="needs-validation" novalidate>
            <div class="mb-3">
                <label for="originAddress" class="form-label">Origin Address</label>
                <input type="text" class="form-control" id="originAddress" placeholder="Enter your home/work address" required>
                <div class="form-text">This address will be used to calculate travel times to all properties.</div>
                <div class="invalid-feedback">
                    Please provide an origin address.
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Save Origin Address</button>
        </form>
    </div>
</div>

<div class="row mt-5">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Add Properties</h5>
                <p class="card-text">Add details about rental opportunities you find on Zillow, Redfin, and other sites.</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Capture Images</h5>
                <p class="card-text">Paste or upload images of properties directly from listing websites.</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Compare Options</h5>
                <p class="card-text">Compare different rental options to make the best decision.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
