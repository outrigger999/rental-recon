{% extends "base.html" %}

{% block title %}Rental Recon - Edit Property{% endblock %}

{% block content %}
<h2>Edit Property</h2>
<form id="propertyForm" class="needs-validation" novalidate>
    <input type="hidden" id="property_id" value="{{ property.id }}">
    
    <div class="row mb-3">
        <div class="col-md-12">
            <label for="address" class="form-label">Address</label>
            <input type="text" class="form-control" id="address" name="address" value="{{ property.address }}" required>
            <div class="invalid-feedback">
                Please provide a property address.
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-4">
            <label for="property_type" class="form-label">Property Type</label>
            <select class="form-select" id="property_type" name="property_type" required>
                <option value="" disabled>Select type...</option>
                <option value="Home" {% if property.property_type == "Home" %}selected{% endif %}>Home</option>
                <option value="Townhome" {% if property.property_type == "Townhome" %}selected{% endif %}>Townhome</option>
                <option value="Apartment" {% if property.property_type == "Apartment" %}selected{% endif %}>Apartment</option>
            </select>
            <div class="invalid-feedback">
                Please select a property type.
            </div>
        </div>
        <div class="col-md-4">
            <label for="price_per_month" class="form-label">Monthly Rent ($)</label>
            <input type="number" class="form-control" id="price_per_month" name="price_per_month" min="0" step="0.01" value="{{ property.price_per_month }}" required>
            <div class="invalid-feedback">
                Please provide a valid monthly rent.
            </div>
        </div>
        <div class="col-md-4">
            <label for="squareFootage" class="form-label">Square Footage</label>
            <input type="number" class="form-control" id="squareFootage" name="square_footage" min="1" step="1" value="{{ property.square_footage }}" required>
            <div class="invalid-feedback">
                Please provide valid square footage.
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-12">
            <label for="description" class="form-label">Property Description</label>
            <textarea class="form-control" id="description" name="description" rows="4" placeholder="Enter details about the property...">{{ property.description or '' }}</textarea>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-12">
            <label for="contacts" class="form-label">Contacts</label>
            <textarea class="form-control" id="contacts" name="contacts" rows="3" placeholder="Enter contact information (landlord, property manager, etc.)">{{ property.contacts or '' }}</textarea>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <label class="form-label">Amenities</label>
            <div class="d-flex flex-wrap gap-4">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="cat_friendly" name="cat_friendly" {% if property.cat_friendly %}checked{% endif %}>
                    <label class="form-check-label" for="cat_friendly">
                        Cat Friendly
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="air_conditioning" name="air_conditioning" {% if property.air_conditioning %}checked{% endif %}>
                    <label class="form-check-label" for="air_conditioning">
                        Air Conditioning
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="on_premises_parking" name="on_premises_parking" {% if property.on_premises_parking %}checked{% endif %}>
                    <label class="form-check-label" for="on_premises_parking">
                        On-premises Parking
                    </label>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <label class="form-label">Main Image</label>
            <div id="mainImageDropzone" class="image-dropzone">
                <div class="dropzone-content">
                    <div class="text-content" id="mainImageTextContent">
                        <p>Paste main image here (Ctrl+V/âŒ˜+V) or click to upload</p>
                        <input type="file" id="mainImageInput" class="d-none" accept="image/*">
                    </div>
                    <div id="mainImagePreview" class="image-preview d-none">
                        <img src="" alt="Main property image" class="img-fluid">
                        <button type="button" class="btn btn-sm btn-danger remove-image">Remove</button>
                    </div>
                    <div id="pasteIndicator" class="paste-indicator d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span>Image pasted! Processing...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <label class="form-label">Additional Images</label>
            <div id="additionalImagesContainer">
                <!-- Additional image upload items will be added here -->
            </div>
            <button type="button" id="addImageBtn" class="btn btn-outline-secondary mt-2">
                <i class="bi bi-plus-circle"></i> Add Another Image
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <button type="submit" id="submitBtn" class="btn btn-primary">Update Property</button>
            <a href="/properties/{{ property.id }}" class="btn btn-outline-secondary ms-2">Cancel</a>
        </div>
    </div>
</form>

<template id="additionalImageTemplate">
    <div class="additional-image-item mb-3">
        <div class="image-dropzone">
            <div class="dropzone-content">
                <div class="text-content">
                    <p>Click to upload image</p>
                    <input type="file" class="additional-image-input d-none" accept="image/*">
                </div>
                <div class="image-preview d-none">
                    <img src="" alt="Property image" class="img-fluid">
                    <button type="button" class="btn btn-sm btn-danger remove-image">Remove</button>
                </div>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
    let propertyId = null;
    let mainImageData = null;
    let additionalImages = [];
    let existingMainImage = null;
    let existingAdditionalImages = [];

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize propertyId from hidden input
        propertyId = document.getElementById('property_id').value;
        
        // Load existing images
        loadExistingImages();
        
        // Handle form submission
        const form = document.getElementById('propertyForm');
        form.addEventListener('submit', handleFormSubmit);
        
        // Set up image paste and drop functionality for main image
        const mainImageDropzone = document.getElementById('mainImageDropzone');
        const mainImageInput = document.getElementById('mainImageInput');
        const pasteIndicator = document.getElementById('pasteIndicator');
        
        // Handle paste events for main image
        document.addEventListener('paste', function(event) {
            // Always capture paste events anywhere in the document
            handlePaste(event);
        });
        
        // Handle click on the dropzone to trigger file input
        mainImageDropzone.addEventListener('click', function() {
            mainImageInput.click();
        });
        
        // Handle file selection for main image
        mainImageInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                handleFileSelect(this.files[0], 'main');
            }
        });
        
        // Handle remove main image button
        document.querySelector('#mainImagePreview .remove-image').addEventListener('click', function() {
            resetMainImage();
        });
        
        // Handle add additional image button
        document.getElementById('addImageBtn').addEventListener('click', addAdditionalImageField);
    });

    async function loadExistingImages() {
        try {
            const response = await fetch(`/api/properties/${propertyId}`);
            if (response.ok) {
                const property = await response.json();
                
                // Load images from the images array
                if (property.images && property.images.length > 0) {
                    property.images.forEach(image => {
                        // Use property-specific directory structure
                        const imageUrl = `/static/images/property_${propertyId}/${image.filename}`;
                        
                        if (image.is_main) {
                            // This is the main image
                            existingMainImage = imageUrl;
                            displayExistingMainImage(imageUrl);
                        } else {
                            // This is an additional image
                            existingAdditionalImages.push(imageUrl);
                            displayExistingAdditionalImage(imageUrl);
                        }
                    });
                }
            }
        } catch (error) {
            console.error('Error loading existing images:', error);
        }
    }

    function displayExistingMainImage(imageUrl) {
        const textContent = document.getElementById('mainImageTextContent');
        const preview = document.getElementById('mainImagePreview');
        const img = preview.querySelector('img');
        
        img.src = imageUrl;
        textContent.classList.add('d-none');
        preview.classList.remove('d-none');
    }

    function displayExistingAdditionalImage(imageUrl) {
        const container = document.getElementById('additionalImagesContainer');
        const template = document.getElementById('additionalImageTemplate');
        const clone = template.content.cloneNode(true);
        
        const textContent = clone.querySelector('.text-content');
        const preview = clone.querySelector('.image-preview');
        const img = preview.querySelector('img');
        const removeBtn = preview.querySelector('.remove-image');
        
        img.src = imageUrl;
        textContent.classList.add('d-none');
        preview.classList.remove('d-none');
        
        // Handle remove button for existing image
        removeBtn.addEventListener('click', function() {
            const item = removeBtn.closest('.additional-image-item');
            // Remove from existing images array
            const index = existingAdditionalImages.indexOf(imageUrl);
            if (index > -1) {
                existingAdditionalImages.splice(index, 1);
            }
            item.remove();
        });
        
        container.appendChild(clone);
    }

    function handlePaste(event) {
        const items = event.clipboardData.items;
        
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                event.preventDefault();
                const blob = items[i].getAsFile();
                
                // Show paste indicator
                const pasteIndicator = document.getElementById('pasteIndicator');
                const textContent = document.getElementById('mainImageTextContent');
                textContent.classList.add('d-none');
                pasteIndicator.classList.remove('d-none');
                
                // Process the image
                processImageBlob(blob);
                break;
            }
        }
    }

    function processImageBlob(blob) {
        const reader = new FileReader();
        reader.onload = function(e) {
            mainImageData = {
                data: e.target.result,
                file: blob
            };
            
            // Hide paste indicator and show preview
            const pasteIndicator = document.getElementById('pasteIndicator');
            const preview = document.getElementById('mainImagePreview');
            const img = preview.querySelector('img');
            
            pasteIndicator.classList.add('d-none');
            img.src = e.target.result;
            preview.classList.remove('d-none');
        };
        reader.readAsDataURL(blob);
    }

    function handleFileSelect(file, type) {
        if (type === 'main') {
            mainImageData = {
                data: null,
                file: file
            };
            
            const reader = new FileReader();
            reader.onload = function(e) {
                mainImageData.data = e.target.result;
                
                const textContent = document.getElementById('mainImageTextContent');
                const preview = document.getElementById('mainImagePreview');
                const img = preview.querySelector('img');
                
                textContent.classList.add('d-none');
                img.src = e.target.result;
                preview.classList.remove('d-none');
            };
            reader.readAsDataURL(file);
        } else {
            // Handle additional image
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = {
                    data: e.target.result,
                    file: file
                };
                additionalImages.push(imageData);
                
                // Find the parent additional image item
                const input = file.target || document.querySelector('.additional-image-input');
                const item = input.closest('.additional-image-item');
                const textContent = item.querySelector('.text-content');
                const preview = item.querySelector('.image-preview');
                const img = preview.querySelector('img');
                
                textContent.classList.add('d-none');
                img.src = e.target.result;
                preview.classList.remove('d-none');
            };
            reader.readAsDataURL(file);
        }
    }

    function resetMainImage() {
        mainImageData = null;
        existingMainImage = null;
        
        const textContent = document.getElementById('mainImageTextContent');
        const preview = document.getElementById('mainImagePreview');
        const img = preview.querySelector('img');
        
        textContent.classList.remove('d-none');
        preview.classList.add('d-none');
        img.src = '';
    }

    function addAdditionalImageField() {
        const container = document.getElementById('additionalImagesContainer');
        const template = document.getElementById('additionalImageTemplate');
        const clone = template.content.cloneNode(true);
        
        const dropzone = clone.querySelector('.image-dropzone');
        const input = clone.querySelector('.additional-image-input');
        const removeBtn = clone.querySelector('.remove-image');
        
        // Handle click on dropzone
        dropzone.addEventListener('click', function() {
            input.click();
        });
        
        // Handle file selection
        input.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                handleFileSelect(this.files[0], 'additional');
            }
        });
        
        // Handle remove button
        removeBtn.addEventListener('click', function() {
            const item = removeBtn.closest('.additional-image-item');
            // Remove from additionalImages array if it was added
            const img = item.querySelector('img');
            if (img.src) {
                const index = additionalImages.findIndex(imgData => imgData.data === img.src);
                if (index > -1) {
                    additionalImages.splice(index, 1);
                }
            }
            item.remove();
        });
        
        container.appendChild(clone);
    }

    async function handleFormSubmit(e) {
        e.preventDefault();
        
        if (!e.target.checkValidity()) {
            e.stopPropagation();
            e.target.classList.add('was-validated');
            return;
        }

        // Disable submit button and show loading state
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Updating...';

        try {
            const formData = new FormData();
            
            // Add form fields to FormData
            formData.append('address', document.getElementById('address').value);
            formData.append('property_type', document.getElementById('property_type').value);
            formData.append('price_per_month', document.getElementById('price_per_month').value);
            formData.append('square_footage', document.getElementById('squareFootage').value);
            formData.append('description', document.getElementById('description').value);
            formData.append('contacts', document.getElementById('contacts').value);
            formData.append('cat_friendly', document.getElementById('cat_friendly').checked);
            formData.append('air_conditioning', document.getElementById('air_conditioning').checked);
            formData.append('on_premises_parking', document.getElementById('on_premises_parking').checked);

            // Add main image if new one was selected
            if (mainImageData && mainImageData.file) {
                formData.append('main_image', mainImageData.file);
            } else if (existingMainImage) {
                formData.append('keep_main_image', 'true');
            }

            // Add additional images
            additionalImages.forEach((imageData, index) => {
                if (imageData.file) {
                    formData.append(`additional_image_${index}`, imageData.file);
                }
            });
            
            // Add existing additional images to keep
            existingAdditionalImages.forEach((imageUrl, index) => {
                formData.append(`keep_additional_image_${index}`, imageUrl);
            });

            const response = await fetch(`/api/properties/${propertyId}`, {
                method: 'PUT',
                body: formData
            });

            if (response.ok) {
                // Success - redirect to property details page
                window.location.href = `/properties/${propertyId}`;
            } else {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Failed to update property');
            }
        } catch (error) {
            console.error('Error updating property:', error);
            alert('Error updating property: ' + error.message);
            
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Update Property';
        }
    }
</script>
{% endblock %}
