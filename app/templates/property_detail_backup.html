{% extends "base.html" %}

{% block title %}Rental Recon - Property Details{% endblock %}

{% block content %}
<!-- Image Zoom Modal -->
<div class="modal fade" id="imageZoomModal" tabindex="-1" aria-labelledby="imageZoomModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageZoomModalLabel">Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="zoomedImage" src="" class="img-fluid" alt="Zoomed property image">
            </div>
        </div>
    </div>
</div>

<div class="mb-3">
    <a href="/properties" class="btn btn-outline-secondary">
        &larr; Back to Properties
    </a>
</div>

<div id="propertyDetailContainer">
    <div class="text-center py-5">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading property details...</p>
    </div>
</div>

<template id="propertyDetailTemplate">
    <div class="property-detail">
        <h2 class="property-address mb-4"></h2>
        
        <div class="row">
            <div class="col-lg-8">
                <!-- Image carousel -->
                <div id="propertyCarousel" class="carousel slide mb-4" data-bs-ride="carousel">
                    <div class="carousel-inner property-images">
                        <!-- Images will be populated by JavaScript -->
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#propertyCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#propertyCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Property Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <p class="property-type"></p>
                                <p class="property-price"></p>
                                <p class="property-sqft"></p>
                                
                                <div class="property-description-section" style="display: none;">
                                    <h5 class="mt-3">Description</h5>
                                    <p class="property-description"></p>
                                </div>
                                
                                <h4 class="mt-4">Amenities</h4>
                                <div class="amenities-list">
                                    <span class="amenity cat-friendly badge bg-success me-1 d-none">Cat Friendly</span>
                                    <span class="amenity air-conditioning badge bg-success me-1 d-none">Air Conditioning</span>
                                    <span class="amenity on-premises-parking badge bg-success me-1 d-none">On-premises Parking</span>
                                </div> 
                                 data-bs-target="#imageZoomModal"
                                 style="cursor: zoom-in;">
                        </div>
                        {% else %}
                        <div class="carousel-item active">
                            <div class="d-block w-100 bg-light text-center p-5">
                                <i class="bi bi-card-image fs-1"></i>
                                <p>No images available</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% if property.images|length > 1 %}
                    <button class="carousel-control-prev" type="button" data-bs-target="#propertyCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#propertyCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                    {% endif %}
                </div>
                
                <!-- Thumbnail gallery -->
                <div class="image-thumbnails row g-2 mb-4">
                    <!-- Will be populated with thumbnails -->
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Property Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h2 class="mb-3">{{ property.address }}</h2>
                                <p class="property-type">{{ property.property_type }}</p>
                                <p><strong>Price:</strong> ${{ property.price_per_month|round|int }}/month</p>
                                <p><strong>Size:</strong> {{ property.square_footage|round|int }} sq ft</p>
                                
                                {% if property.description %}
                                <div class="mb-3">
                                    <h5 class="mt-3">Description</h5>
                                    <p class="property-description">{{ property.description }}</p>
                                </div>
                                {% endif %}
                                
                                <h4 class="mt-4">Amenities</h4>
                                <ul class="list-unstyled">
                                    {% if property.cat_friendly %}<li><span class="badge bg-success">Cat Friendly</span></li>{% endif %}
                                    {% if property.air_conditioning %}<li><span class="badge bg-success">Air Conditioning</span></li>{% endif %}
                                    {% if property.on_premises_parking %}<li><span class="badge bg-success">On-premises Parking</span></li>{% endif %}
                                </ul>
                                
                                <h4 class="mt-4">Travel Times</h4>
                                <div class="travel-times card p-3 mb-4">
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <div class="input-group input-group-sm mb-2">
                                                <span class="input-group-text">8:30 AM</span>
                                                <input type="number" class="form-control travel-time" 
                                                       id="travel_time_830am" 
                                                       placeholder="Minutes" 
                                                       value="{{ property.travel_time_830am or '' }}">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="input-group input-group-sm mb-2">
                                                <span class="input-group-text">9:30 AM</span>
                                                <input type="number" class="form-control travel-time" 
                                                       id="travel_time_930am" 
                                                       placeholder="Minutes" 
                                                       value="{{ property.travel_time_930am or '' }}">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="input-group input-group-sm mb-2">
                                                <span class="input-group-text">Midday</span>
                                                <input type="number" class="form-control travel-time" 
                                                       id="travel_time_midday" 
                                                       placeholder="Minutes" 
                                                       value="{{ property.travel_time_midday or '' }}">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="input-group input-group-sm mb-2">
                                                <span class="input-group-text">6:30 PM</span>
                                                <input type="number" class="form-control travel-time" 
                                                       id="travel_time_630pm" 
                                                       placeholder="Minutes" 
                                                       value="{{ property.travel_time_630pm or '' }}">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text">7:30 PM</span>
                                                <input type="number" class="form-control travel-time" 
                                                       id="travel_time_730pm" 
                                                       placeholder="Minutes" 
                                                       value="{{ property.travel_time_730pm or '' }}">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <button class="btn btn-sm btn-primary w-100" id="saveTravelTimes">Save Times</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <h4 class="mt-4">Visit Notes</h4>
                        <div class="card mb-3">
                            <div class="card-body">
                                <div id="notesList" class="notes-list mb-3">
                                    <!-- Notes will be populated here dynamically -->
                                    <div class="text-center py-2 text-muted note-placeholder">
                                        <small>No notes added yet</small>
                                    </div>
                                </div>
                                
                                <div class="add-note-form">
                                    <div class="form-floating mb-2">
                                        <textarea class="form-control" id="newNoteContent" placeholder="Add a note" style="height: 100px"></textarea>
                                        <label for="newNoteContent">Add a note about your visit</label>
                                    </div>
                                    <button id="addNoteBtn" class="btn btn-primary w-100">Add Note</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2">
                    <a href="#" class="btn btn-primary edit-property-btn">Edit Property</a>
                    <button class="btn btn-danger delete-property-btn">Delete Property</button>
                </div>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
    // Image zoom functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Set up click handlers for all zoomable images
        const zoomableImages = document.querySelectorAll('.zoomable-image');
        const zoomedImage = document.getElementById('zoomedImage');
        
        zoomableImages.forEach(img => {
            img.addEventListener('click', function() {
                zoomedImage.src = this.src;
                document.getElementById('imageZoomModalLabel').textContent = this.alt || 'Property Image';
            });
        });
        
        // Add event listener for the Save Times button
        const saveTravelTimesBtn = document.getElementById('saveTravelTimes');
        if (saveTravelTimesBtn) {
            saveTravelTimesBtn.addEventListener('click', saveTravelTimes);
        }
    });

    let propertyId;
    let propertyData;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Get property ID from URL
        const pathParts = window.location.pathname.split('/');
        propertyId = pathParts[pathParts.length - 1];
        
        // Load property details
        loadPropertyDetails(propertyId);
        
        // Add event listeners for buttons (will be added dynamically)
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('delete-property-btn')) {
                confirmDeleteProperty();
            } else if (event.target.id === 'saveTravelTimes') {
                saveTravelTimes();
            } else if (event.target.id === 'addNoteBtn') {
                addNote();
            } else if (event.target.classList.contains('delete-note-btn')) {
                const noteId = event.target.dataset.noteId;
                deleteNote(noteId);
            }
        });
    });
    
    async function loadPropertyDetails(id) {
        try {
            const response = await fetch(`/api/properties/${id}`);
            if (!response.ok) {
                throw new Error('Property not found');
            }
            
            propertyData = await response.json();
            displayPropertyDetails(propertyData);
            loadPropertyNotes(id);
        } catch (error) {
            console.error('Error loading property details:', error);
            document.getElementById('propertyDetailContainer').innerHTML = `
                <div class="alert alert-danger">
                    <p>Error loading property details. Property may not exist or has been deleted.</p>
                    <a href="/properties" class="btn btn-primary mt-2">Back to Properties</a>
                </div>
            `;
        }
    }
    
    function displayPropertyDetails(property) {
        const container = document.getElementById('propertyDetailContainer');
        const template = document.getElementById('propertyDetailTemplate');
        const clone = template.content.cloneNode(true);
        
        // Set property details
        clone.querySelector('.property-address').textContent = property.address;
        clone.querySelector('.property-type').textContent = `Property Type: ${property.property_type}`;
        clone.querySelector('.property-price').textContent = `Monthly Rent: $${property.price_per_month.toLocaleString()}`;
        clone.querySelector('.property-sqft').textContent = `Size: ${property.square_footage.toLocaleString()} sq ft`;
        
        // Set edit link
        clone.querySelector('.edit-property-btn').href = `/properties/${property.id}/edit`;
        
        // Set amenities
        if (property.cat_friendly) {
            clone.querySelector('.amenity.cat-friendly').classList.remove('d-none');
        }
        if (property.air_conditioning) {
            clone.querySelector('.amenity.air-conditioning').classList.remove('d-none');
        }
        if (property.on_premises_parking) {
            clone.querySelector('.amenity.parking').classList.remove('d-none');
        }
        
        // Handle images
        if (property.images && property.images.length > 0) {
            // Remove the "no images" placeholder
            const carousel = clone.querySelector('#propertyImageCarousel .carousel-inner');
            carousel.innerHTML = '';
            
            // Add images to carousel
            property.images.forEach((image, index) => {
                const carouselItem = document.createElement('div');
                carouselItem.classList.add('carousel-item');
                if (index === 0) {
                    carouselItem.classList.add('active');
                }
                
                carouselItem.innerHTML = `
                    <img src="/static/images/property_${property.id}/${image.filename}" 
                         class="d-block w-100" alt="Property image ${index + 1}"
                         style="height: 400px; object-fit: cover;">
                `;
                
                carousel.appendChild(carouselItem);
                
                // Add thumbnail
                const thumbnailCol = document.createElement('div');
                thumbnailCol.classList.add('col-3', 'col-md-2');
                thumbnailCol.innerHTML = `
                    <img src="/static/images/property_${property.id}/${image.filename}" 
                         class="img-thumbnail" alt="Thumbnail ${index + 1}"
                         data-bs-target="#propertyImageCarousel" 
                         data-bs-slide-to="${index}">
                `;
                
                clone.querySelector('.image-thumbnails').appendChild(thumbnailCol);
                
                // Add indicator
                const indicator = document.createElement('button');
                indicator.setAttribute('type', 'button');
                indicator.setAttribute('data-bs-target', '#propertyImageCarousel');
                indicator.setAttribute('data-bs-slide-to', index);
                if (index === 0) {
                    indicator.classList.add('active');
                    indicator.setAttribute('aria-current', 'true');
                }
                indicator.setAttribute('aria-label', `Slide ${index + 1}`);
                
                clone.querySelector('.carousel-indicators').appendChild(indicator);
            });
        }
        
        // Clear container and append clone
        container.innerHTML = '';
        container.appendChild(clone);
        
        // Initialize Bootstrap components
        const carousel = new bootstrap.Carousel(document.getElementById('propertyImageCarousel'));
        
        // Add click events for thumbnails
        document.querySelectorAll('.image-thumbnails img').forEach(img => {
            img.addEventListener('click', function() {
                const slideIndex = this.getAttribute('data-bs-slide-to');
                carousel.to(parseInt(slideIndex));
            });
        });
    }
    
    async function confirmDeleteProperty() {
        if (confirm('Are you sure you want to delete this property? This action cannot be undone.')) {
            deleteProperty(propertyId);
        }
    }
    
    async function deleteProperty(id) {
        try {
            const response = await fetch(`/api/properties/${id}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                throw new Error('Failed to delete property');
            }
            
            // Redirect to properties page
            window.location.href = '/properties';
        } catch (error) {
            console.error('Error deleting property:', error);
            alert('Error deleting property. Please try again.');
        }
    }
    
    async function saveTravelTimes() {
        const travelTimes = {
            travel_time_830am: document.getElementById('travel_time_830am').value || null,
            travel_time_930am: document.getElementById('travel_time_930am').value || null,
            travel_time_midday: document.getElementById('travel_time_midday').value || null,
            travel_time_630pm: document.getElementById('travel_time_630pm').value || null,
            travel_time_730pm: document.getElementById('travel_time_730pm').value || null
        };
        
        try {
            const response = await fetch(`/api/properties/${propertyId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(travelTimes)
            });
            
            if (!response.ok) {
                throw new Error('Failed to update travel times');
            }
            
            const result = await response.json();
            propertyData = result;
            
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.setAttribute('role', 'alert');
            alertDiv.innerHTML = `
                Travel times updated successfully!
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.querySelector('.travel-times').after(alertDiv);
            
            // Auto dismiss after 3 seconds
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(alertDiv);
                bsAlert.close();
            }, 3000);
        } catch (error) {
            console.error('Error updating travel times:', error);
            alert('Error updating travel times. Please try again.');
        }
    }
    
    async function loadPropertyNotes(propertyId) {
        try {
            const response = await fetch(`/api/properties/${propertyId}/notes`);
            if (!response.ok) {
                throw new Error('Failed to load notes');
            }
            
            const notes = await response.json();
            displayNotes(notes);
        } catch (error) {
            console.error('Error loading notes:', error);
            // Don't show error to user, just log it
        }
    }
    
    function displayNotes(notes) {
        const notesList = document.getElementById('notesList');
        const placeholder = notesList.querySelector('.note-placeholder');
        
        if (notes && notes.length > 0) {
            // Remove placeholder if there are notes
            if (placeholder) {
                placeholder.remove();
            }
            
            // Sort notes by date (newest first)
            notes.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            // Display each note
            notes.forEach(note => {
                const noteElement = createNoteElement(note);
                notesList.appendChild(noteElement);
            });
        }
    }
    
    function createNoteElement(note) {
        const noteDate = new Date(note.created_at);
        const formattedDate = noteDate.toLocaleDateString('en-US', { 
            year: 'numeric', month: 'short', day: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });
        
        const noteDiv = document.createElement('div');
        noteDiv.className = 'note-item card mb-2';
        noteDiv.id = `note-${note.id}`;
        noteDiv.innerHTML = `
            <div class="card-body pb-1">
                <div class="d-flex justify-content-between align-items-start">
                    <small class="text-muted">${formattedDate}</small>
                    <button class="btn btn-sm btn-outline-danger delete-note-btn" data-note-id="${note.id}">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <p class="mt-2 mb-1">${note.content}</p>
            </div>
        `;
        
        return noteDiv;
    }
    
    async function addNote() {
        const content = document.getElementById('newNoteContent').value.trim();
        if (!content) {
            alert('Please enter a note before submitting');
            return;
        }
        
        try {
            const response = await fetch(`/api/properties/${propertyId}/notes`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content: content })
            });
            
            if (!response.ok) {
                throw new Error('Failed to add note');
            }
            
            const newNote = await response.json();
            
            // Add the new note to the list
            const notesList = document.getElementById('notesList');
            const placeholder = notesList.querySelector('.note-placeholder');
            if (placeholder) {
                placeholder.remove();
            }
            
            const noteElement = createNoteElement(newNote);
            notesList.insertBefore(noteElement, notesList.firstChild);
            
            // Clear the form
            document.getElementById('newNoteContent').value = '';
            
        } catch (error) {
            console.error('Error adding note:', error);
            alert('Error adding note. Please try again.');
        }
    }
    
    async function deleteNote(noteId) {
        if (!confirm('Are you sure you want to delete this note?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/properties/${propertyId}/notes/${noteId}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                throw new Error('Failed to delete note');
            }
            
            // Remove the note from the DOM
            const noteElement = document.getElementById(`note-${noteId}`);
            if (noteElement) {
                noteElement.remove();
            }
            
            // If no notes left, show the placeholder
            const notesList = document.getElementById('notesList');
            if (notesList.children.length === 0) {
                const placeholder = document.createElement('div');
                placeholder.className = 'text-center py-2 text-muted note-placeholder';
                placeholder.innerHTML = '<small>No notes added yet</small>';
                notesList.appendChild(placeholder);
            }
            
        } catch (error) {
            console.error('Error deleting note:', error);
            alert('Error deleting note. Please try again.');
        }
    }
</script>
{% endblock %}
